# 要件定義書

## 概要

price and point highlighterでSlack/Mastodonに通知したタイミングで、sale_checkerでも使用しているS3のファイルから通知したASINのレコードを削除するシステムを構築します。S3への直接アクセスはできないため、API Gateway経由でLambdaを実行してS3を更新します。また、家の固定IPではない環境からのアクセス制御のため、定期的にIPアドレスを更新するバッチも必要です。

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、API GatewayとLambda関数を含む完全なインフラ用のCloudFormationテンプレートを作成したい。これにより、S3更新APIを一貫性を持って確実にデプロイできるようになる。

#### 受け入れ基準

1. CloudFormationテンプレートがデプロイされた時、適切なリソース構造でAPI Gatewayが作成される
2. CloudFormationテンプレートがデプロイされた時、S3操作用のLambda関数が作成される
3. CloudFormationテンプレートがデプロイされた時、Lambda関数とAPI Gatewayが適切に統合される
4. API Gatewayが作成された時、特定のIPアドレスへのアクセスを制限するリソースポリシーを持つ
5. Lambda関数が作成された時、S3への読み書き権限を持つIAMロールが割り当てられる
6. API Gatewayがリクエストを受信した時、リクエスト形式を検証し適切に認証を行う

### 要件2

**ユーザーストーリー:** システム管理者として、現在のIPアドレスでAPI Gatewayリソースポリシーを更新するバッチプロセスが欲しい。これにより、動的IP環境からAPIにアクセス可能な状態を維持できる。

#### 受け入れ基準

1. バッチプロセスが実行された時、現在のパブリックIPアドレスを検出する
2. 現在のIPが設定されたIPと異なる時、バッチはAPI Gatewayリソースポリシーを更新する
3. リソースポリシーが更新された時、現在のIPのみを許可することでセキュリティを維持する
4. バッチプロセスが失敗した時、トラブルシューティング用の適切なエラーメッセージをログに記録する

### 要件3

**ユーザーストーリー:** 開発者として、S3ファイルを更新するGo言語で書かれたLambda関数が欲しい。これにより、通知送信時にASINレコードを効率的に削除できる。

#### 受け入れ基準

1. LambdaがAPI Gatewayリクエストを受信した時、ASINパラメータを検証する
2. ASINが有効な時、LambdaはS3ファイルから対応するレコードを削除する
3. S3更新が成功した時、Lambdaは成功レスポンスを返す
4. S3更新が失敗した時、Lambdaは詳細を含む適切なエラーレスポンスを返す
5. Lambdaがリクエストを処理する時、監査用にすべての操作をログに記録する

### 要件4

**ユーザーストーリー:** 開発者として、Go言語で書かれたLambda関数をAWSにデプロイするスクリプトが欲しい。これにより、Lambda関数のコードを簡単に更新できる。

#### 受け入れ基準

1. デプロイスクリプトが実行された時、Go言語のコードをビルドしてバイナリを作成する
2. バイナリが作成された時、zipファイルにパッケージングする
3. zipファイルが作成された時、AWS CLIを使用してLambda関数のコードを更新する
4. デプロイが成功した時、成功メッセージを表示する
5. デプロイが失敗した時、適切なエラーメッセージを表示する

### 要件5

**ユーザーストーリー:** price and point highlighterのユーザーとして、通知送信時にS3レコードが自動的にクリーンアップされることを望む。これにより、sale_checkerでの重複通知を防げる。

#### 受け入れ基準

1. price and point highlighterがSlack通知を送信した時、API Gatewayを呼び出してS3からASINを削除する
2. price and point highlighterがMastodon通知を送信した時、API Gatewayを呼び出してS3からASINを削除する
3. API Gateway呼び出しが成功した時、システムは成功したクリーンアップをログに記録する
4. API Gateway呼び出しが失敗した時、システムはエラーをログに記録するが通常の動作は継続する
5. 複数のプラットフォームに通知が送信された時、S3クリーンアップは1つのASINにつき1回だけ呼び出される